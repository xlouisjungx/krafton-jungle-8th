<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bulma CSS 링크 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <!-- 텍스트형태로 되어있는 icon 을 쓸 수 있도록 Font awesome 을 포함하빈다. -->
    <script defer src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>

    <title>{{title}}</title>

    <style>
        .up-button {
            display: flex;
            justify-content: right;
            margin-top: 1%;
            margin-right: 5%;
        }

        .post-button {
            display: flex;
            justify-content: right;
            margin-right: 5%;
        }

        .like-buttons {
            margin: auto;
        }

        .profile-image {
            width: 100px;
            height: 100px;
        }

        .profile-id {
            font-size: 30px;
        }

        .delete-button {
            margin-top: 20px;
        }

        .subtitle-margin-size {
            margin: 0px
        }

        #logout-button {
            margin-left: 10px;
        }

        /* 로고 스타일 */
        .logo {
            display: flex;
            justify-content: left;
            margin: 10px;
        }

        .logo img {
            max-width: 150px;
            /* 로고 크기 조정 */
            height: auto;
        }

        /* 드롭다운 */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        .dropdown-menu {
            display: none;
            /* 기본적으로 숨김 */
        }

        .dropdown-menu.is-active {
            display: block;
            /* 활성화 시 보임 */
        }

        #profile-image {
            cursor: pointer;
            /* 커서를 손가락 모양으로 변경 */
        }

        /* 드롭다운 */
    </style>

    <!-- JS Function -->
    <script>
        $(document).ready(function () {
            $("#post-display").html("");
            showPosts();
        });

        function showPosts() {
            $.ajax({
                type: "GET",
                url: "/main/post",
                data: {},
                success: function (response) {
                    let posts = response["posts"];
                    for (let i = 0; i < posts.length; i++) {
                        makePost(
                            posts[i]["real_user_name"],
                            posts[i]["_id"],
                            posts[i]["image"],
                            posts[i]["poster_id"],
                            posts[i]["post_title"],
                            posts[i]["post_content"],
                            posts[i]["link"],
                            posts[i]["like"],
                            posts[i]["dislike"],
                            posts[i]["post_time"],
                            posts[i]["title"],
                            posts[i]["place"],
                            posts[i]["phone_number"],
                        )
                    }

                    if (posts.length === 0) {
                    }
                }
            })
        }

        function makePost(
            real_user_name,
            post_id,
            image,
            poster_id,
            post_title,
            post_content,
            link,
            likes,
            dislikes,
            post_time,
            place_title,
            place_where,
            place_phone_number,
        ) {
            let temp_html = /*html*/`
            
            <div class="container">
        <div class="side">
            <div class="cardmargin">
                <div class="card">
                    <div class="card-content">
                        <div class="media">

                            <!-- 유저 프사 -->
                            <div class="media-left">
                                <a href="/user_info/${poster_id}">
                                    <figure class="image is-48x48">
                                        <img src="https://bulma.io/assets/images/placeholders/96x96.png"
                                            alt="Profile image" class="profile-image" />
                                    </figure>
                                </a>
                            </div>
                            <!-- 유저 이름 -->
                            <div class="media-content">
                                <p class="title is-4">
                                    <a href="/user_info/${poster_id}">${real_user_name}</a>
                                </p>
                            </div>

                            <!-- 삭제 아이콘 -->
                            <div class="trash" id="delete-${post_id}">
                                <a class="red" href="#" onclick="deletePost('${post_id}', '${poster_id}')">
                                    <i class="fa-solid fa-trash"></i>
                                </a>
                            </div>
                        </div>

                        <!-- 이미지 -->
                        <div class="card-image">
                            <figure class="image is-4by3">
                                <img src="${image}" alt="Placeholder image" />
                            </figure>
                        </div>

                        <!-- 제목, 내용 -->
                        <div class="content">
                            <h1>${post_title}</h1>
                            <p>${post_content}</p>
                            <br>

                            <!-- 가게 위치 -->
                            <div id="place-explanation">
                                ${place_title ? `<p><a href="${link}">${place_title}</a>에서</p>` : ''}
                                <p>${post_time}${place_where ? ` ${place_where}` : ''}</p>
                                ${place_phone_number ? `<p>${place_phone_number}</p>` : ''}
                            </div>
                            <!-- 가게 위치 -->

                            <br>

                            <!-- 아이콘 -->
                            <div class="icongroup" style="color:rgb(34, 39, 83)">
                                <!-- 좋아요 -->
                                <a href="#" onclick="likePost('${post_id}')">
                                    <span class="icon"><i class="fas fa-thumbs-up"></i></span><span
                                        class="movie-likes">${likes}</span>
                                </a>
                                <!-- 좋아요 -->

                                <!-- 싫어요 -->
                                <a href="#" onclick="dislikePost('${post_id}')">
                                    <span class="icon"><i class="fas fa-thumbs-down"></i></span><span
                                        class="movie-likes">${dislikes}</span>
                                </a>
                                <!-- 싫어요 -->
                            </div>
                        </div>
                        <hr>

                        <!-- 댓글 -->
                        <div class="post">
                            <p class="comment-toggle">댓글 달기..</p>
                            <div class="comment-section" style="display: none;">
                                <article class="media">
                                    <figure class="media-left">
                                        <p class="image is-64x64">
                                            <img src="https://bulma.io/assets/images/placeholders/128x128.png"
                                                alt="Profile Image" />
                                        </p>
                                    </figure>
                                    <div class="media-content">
                                        <div class="field">
                                            <p class="control">
                                                <textarea id="reply-${post_id}-content" class="textarea"
                                                    placeholder="댓글을 입력하세요..."></textarea>
                                            </p>
                                        </div>
                                        <nav class="level">
                                            <div class="level-left">
                                                <div class="level-item">
                                                    <button class="button is-info comment-button"
                                                        onclick="createReply('${post_id}')">전송</button>
                                                </div>
                                            </div>
                                        </nav>
                                    </div>
                                </article>
                                <div id="comments-list-${post_id}" class="comments-list"></div>
                            </div>
                        </div>
                        <!-- 댓글 끝 -->
                    </div>
                </div>
            </div>
        </div>
    </div>


            `;


            $("#post-display").append(temp_html);
            if (poster_id !== '{{userid}}') {
                $(`#delete-${post_id}`).hide()
            }
        }

        function deletePost(post_id, poster_id) {
            $.ajax({
                type: "POST",
                url: "/main/post/delete",
                data: {
                    post_id_give: post_id,
                    poster_id_give: poster_id
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('삭제 완료!')
                        $("#post-display").html("");
                        showPosts();
                    } else {
                        alert('삭제 실패ㅠㅠ')
                    }
                }
            });
        }

        function likePost(id) {
            $.ajax({
                type: "POST",
                url: "/main/post/like",
                data: { post_id_give: id },
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('맛있어요 완료!')
                        $("#post-display").html("");
                        showPosts();
                    } else {
                        alert('맛있어요 실패ㅠㅠ')
                    }
                }
            });
        }

        function dislikePost(id) {
            $.ajax({
                type: "POST",
                url: "/main/post/dislike",
                data: { post_id_give: id },
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('맛없어요 완료!')
                        $("#post-display").html("");
                        showPosts();
                    } else {
                        alert('맛없어요 실패ㅠㅠ')
                    }
                }
            });
        }

        function logout() {
            $.ajax({
                type: "POST",
                url: "/login/logout",
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert(response.message);  // "로그아웃 되었습니다." 메시지 표시
                        window.location.href = "/";
                    } else {
                        alert('로그아웃 실패ㅠㅠ')
                    }
                }
            });
        }
    </script>
</head>

<body>
    <div class="container">

        <!-- 헤더 -->
        <nav class="navbar side">

            <!-- 로고 -->
            <div class="logo">
                <img src="/static/Jungle_Sunday.png" alt="로고">
            </div>
            <!-- 로고 -->

            <!-- 드롭다운 -->
            <div class="dropdown ">
                <div class="dropdown-trigger">
                    <figure class="image is-64x64" id="profile-image">
                        <img class="is-rounded" src="https://bulma.io/assets/images/placeholders/96x96.png"
                            alt="Placeholder image" />
                    </figure>
                </div>
                <div class="dropdown-menu is-right" id="dropdown-menu3" role="menu">
                    <div class="dropdown-content">
                        <!-- 글쓰기 post버튼 -->
                        <a href="/post" class="dropdown-item"> {{post}} </a>
                        <div id="post-display"></div>
                        <!-- 글쓰기 post버튼 -->
                        <!-- 내 정보 -->
                        <a href="/user_info/{{userid}}" class="dropdown-item"> 내 정보 </a>
                        <!-- 내 정보 -->
                        <hr class="dropdown-divider" />
                        <a href="#" id="logout-button" class="dropdown-item" style="color:red" onclick="logout()"> 로그아웃 </a>
                    </div>
                </div>
            </div>
            <!-- 드롭다운 -->
        </nav>
    </div>
    <!-- 드롭다운js -->
    <script>
        // 드롭다운 트리거 요소
        const profileImage = document.getElementById('profile-image');
        // 드롭다운 메뉴 요소
        const dropdownMenu = document.getElementById('dropdown-menu3');

        // 프로필 이미지 클릭 이벤트 처리
        profileImage.addEventListener('click', function () {
            dropdownMenu.classList.toggle('is-active'); // 드롭다운 메뉴의 표시 상태를 토글
        });

        // 바깥 클릭 시 드롭다운 닫기
        document.addEventListener('click', function (event) {
            if (!profileImage.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('is-active'); // 드롭다운 메뉴 닫기
            }
        });
    </script>
    <!-- 드롭다운js -->
</body>

</html>